<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="//api.bitrix24.com/api/v1/"></script>
  <script src="https://dev.bambit.ru/burul/resources/js/jquery-3.6.1.min.js"></script>
  <script src="https://dev.bambit.ru/burul/resources/js/bx-24-wrapper.js"></script>
  <script src="https://dev.bambit.ru/burul/resources/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="./js/select2.min.js"></script>
  <script src="./js/air-datepicker.min.js"></script>

  <link rel="stylesheet" href="./css/select2.min.css">
  <link rel="stylesheet" href="./css/air-datepicker.min.css">
  <link rel="stylesheet" href="https://dev.bambit.ru/burul/resources/bootstrap/css/bootstrap.min.css">

  <style>
    #filter {
      min-height: 3.25rem;
    }
  </style>

  <title>app</title>
</head>

<body>
  <main id="app" class="container-fluid">
    <h1>Удаление записей различных сущностей</h1>
    <div class="row row-cols-2">
      <div class="col row">
        <div class="col-12 my-3">
          <h2>Сущность</h2>
          <select id="select-entity" class="form-select form-select-lg">
            <option value="lead" selected>Лиды</option>
            <option value="task">Задачи</option>
            <option value="company">Компании</option>
          </select>
        </div>
        <div class="col-12 my-3">
          <h2>Фильтр</h2>
          <div id="filter" class="form-select form-select-lg form-select-filter" data-bs-toggle="collapse"
            data-bs-target="#filter-menu" aria-expanded="false" aria-controls="filter-menu">
            <div class="row">
              <div class="col-auto filter-card d-inline-flex p-0 my-1" data-target="#id-picker"></div>
              <div class="col-auto filter-card d-inline-flex p-0 my-1" data-target="#user-picker"></div>
              <div class="col-auto filter-card d-inline-flex p-0 my-1" data-target="#date-picker"></div>
              <div class="col-auto filter-card d-inline-flex p-0 my-1" data-target="#name-picker"></div>
              <div class="col-auto filter-card d-inline-flex p-0 my-1" data-target="#status-picker"></div>
            </div>
          </div>
          <div class="collapse" id="filter-menu">
            <form class="p-4 w-100" id="filter-form" data-target="#filter"></form>
          </div>
        </div>
        <div class="col-12 my-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Сущность: <span class="entity-type">Лид</span></h5>
              <div class="row my-1">
                <div class="col my-auto">
                  <p class="card-text">Найдено сущностей: <span class="entity-count">0</span></p>
                </div>
                <div class="col-auto ms-auto">
                  <button class="btn btn-primary filter-button" disabled>Посмотреть</button>
                </div>
              </div>
              <div class="d-grid">
                <button class="btn btn-danger filter-button" disabled>Удалить все</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script>
    const BX24Client = new BX24Wrapper();
    BX24.init(BX24.getAuth());

    class Entities {
      //надо так же переделать в класс?
      /** @property methods
       * must be a Object like:
       * methods = {
       *   list: { //list method
       *     method: 'tasks.task.list',
       *     filter: ... //default filter if needed
       *     select: ... //default select if needed (dont forgot about ID if u set this param, this is required)
       *   },
       *   delete: { //delete method
       *     method: 'tasks.task.delete',
       *     param: 'taskId', //required id field name for method
       *   }
       * }
       **/
      constructor(methods) {
        if (!methods instanceof Object) {
          throw 'methods prop must be a Object!'
        }
        this.methods = methods;
        this.client = new BX24Wrapper();
        this.entityList;
      }
      async get(settings) {
        let __method = settings.method || this.methods.list.method, __filter = settings.filter || this.methods.list.filter;
        if (!__filter || !__method) return;
        let res = await this.client.call(__method, {
          order: settings.order || { 'ID': 'ASC' },
          filter: __filter,
          select: settings.select || this.methods.list.select || ['ID'],
          start: -1,
        });
        if (res.error()) throw 'Request error: ' + res.error();
        let local_entityList = res.data();
        while (res.more()) {
          res = await this.client.next(res);
          if (res.error()) throw 'Request error: ' + res.error();
          local_entityList = local_entityList.concat(res.data());
        }
        return this.entityList = local_entityList;
      }
      async count(settings) {
        let __method = settings.method || this.methods.list.method, __filter = settings.filter || this.methods.list.filter;
        if (!__method) return;
        let res = await this.client.call(__method, {
          order: { 'ID': 'ASC' },
          filter: __filter,
          select: ['ID'],
        });
        if (res.error()) throw 'Request error: ' + res.error();
        return res.total();
      }
      async delete() {
        if (!this.entityList) return;
        let local_entityList = JSON.parse(JSON.stringify(!this.entityList)), result = [], length = 50;
        while (local_entityList.length) result.push(local_entityList.splice(0, length));
        let cmds = [];
        for (let page of result) {
          cmds.push(page.map(e => ({
            method: this.methods.delete.method,
            params: { [this.methods.delete.param]: e.ID }
          })));
        }
        for (let page of cmds) {
          await this.client.callBatch(page);
        }
      }
    }
    //пример использования
    // async function () {
    //   let a = new Entities({
    //     list: {
    //       method: 'crm.lead.list',
    //     },
    //     delete: {
    //       method: 'crm.lead.delete',
    //       param: 'id',
    //     }
    //   });

    //   let b = await a.get({ filter: { 'ASSIGNED_BY_ID': 92 } });
    //   console.log(b);
    // }

    //каждый из методов объекта представляет из себя соотвествующий своему типу преобразователь данных формы в filter для list метода
    //переделать в класс?
    /** @param query
     * must be like obj {
     *    'users[]': [], //unset if empty
     *    title: String,
     *    min_id: String,
     *    max_id: max_id,
     *    start_date: String (like dd.mm.yyyy),
     *    end_date: String (like dd.mm.yyyy),
     *    'status[]': [], //unset if empty
     * }
     **/
    const SERIALIZE = {
      serializeLead: function (query) {
        let ___filter = {};
        if (query['users[]']) ___filter.ASSIGNED_BY_ID = query['users[]'];
        if (query.title) ___filter.TITLE = query.title;
        if (query.min_id) ___filter['>ID'] = parseInt(query.min_id);
        if (query.max_id) ___filter['<ID'] = parseInt(query.max_id);
        if (query.start_date) ___filter['>DATE_CREATE'] = this.date2str(query.start_date) + 'T00:00:00';
        if (query.end_date) ___filter['<DATE_CREATE'] = this.date2str(query.end_date) + 'T23:59:59';
        if (query['status[]']) ___filter.STATUS_ID = query['status[]'];
        return ___filter;
      },
      serializeCompany: function (query) {
        let ___filter = {};
        if (query['users[]']) ___filter.ASSIGNED_BY_ID = query['users[]'];
        if (query.title) ___filter.TITLE = query.title;
        if (query.min_id) ___filter['>ID'] = parseInt(query.min_id);
        if (query.max_id) ___filter['<ID'] = parseInt(query.max_id);
        if (query.start_date) ___filter['>DATE_CREATE'] = this.date2str(query.start_date) + 'T00:00:00';
        if (query.end_date) ___filter['<DATE_CREATE'] = this.date2str(query.end_date) + 'T23:59:59';
        return ___filter;
      },
      serializeTask: function (query) {
        let ___filter = {};
        if (query['users[]']) ___filter.RESPONSIBLE_ID = query['users[]'];
        if (query.title) ___filter.TITLE = query.title;
        if (query.min_id) ___filter['>ID'] = parseInt(query.min_id);
        if (query.max_id) ___filter['<ID'] = parseInt(query.max_id);
        if (query.start_date) ___filter['>CREATED_DATE'] = this.date2str(query.start_date) + 'T00:00:00';
        if (query.end_date) ___filter['<CREATED_DATE'] = this.date2str(query.end_date) + 'T23:59:59';
        if (query['status[]']) ___filter.REAL_STATUS = query['status[]'];
        return ___filter;
      },
      //вспомогательные функции
      date2str: function (date_string) {
        let tmp = date_string.split('.');
        let d = new Date(tmp[2] + '-' + tmp[1] + '-' + tmp[0]);
        return d.getFullYear() + '-' + this.paddatepart(1 + d.getMonth()) + '-' + this.paddatepart(d.getDate());
      },
      paddatepart: function (part) {
        return part >= 10 ? part.toString() : '0' + part.toString();
      }
    }

    const ENTITIES = [
      {
        name: 'lead',
        label: 'Лид',
        new: function () {
          return new Entities({
            list: {
              method: 'crm.lead.list',
            },
            delete: {
              method: 'crm.lead.delete',
              param: 'id',
            }
          })
        },
        serialize: function (query) {
          return SERIALIZE.serializeLead(query);
        },
      },
      {
        name: 'company',
        label: 'Компания',
        new: function () {
          return new Entities({
            list: {
              method: 'crm.company.list',
            },
            delete: {
              method: 'crm.company.delete',
              param: 'id',
            }
          })
        },
        serialize: function (query) {
          return SERIALIZE.serializeCompany(query);
        },
      },
      {
        name: 'task',
        label: 'Задача',
        new: function () {
          return new Entities({
            list: {
              method: 'tasks.task.list',
            },
            delete: {
              method: 'tasks.task.delete',
              param: 'taskId',
            }
          })
        },
        serialize: function (query) {
          return SERIALIZE.serializeTask(query);
        },
      },
    ];

    //самописный обработчик формы, выплевывает ассоциативный объект
    //!!! выпленет массив только если обрабатываемый инпут имеет в названии [], например name="users[]" !!!
    jQuery.fn.serializeObject = function () {
      var arrayData, objectData;
      arrayData = this.serializeArray();
      objectData = {};
      $.each(arrayData, function () {
        var value;
        if (this.value != null) {
          value = this.value;
        } else {
          value = '';
        }
        if (this.name.includes('[]')) {
          objectData[this.name] != null ? objectData[this.name].push(value) : objectData[this.name] = [value];
        } else {
          objectData[this.name] = value;
        }
      });
      return objectData;
    };
  </script>
  <script>//В этом блоке вся работа с DOM деревом
    /**
     * Блок с инициализаторами пикеров разных типов данных
     **/
    function declOfNum(number, titles) {
      cases = [2, 0, 1, 1, 1, 2];
      return titles[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
    }
    function date2str(d) {
      return paddatepart(d.getDate()) + '.' + paddatepart(1 + d.getMonth()) + '.' + d.getFullYear();
    }
    function paddatepart(part) {
      return part >= 10 ? part.toString() : '0' + part.toString();
    }
    function dateInMoscow() {
      return new Date(
        new Date().toLocaleString('en-US', { timeZone: 'Europe/Moscow' })
      );
    }

    const createSelect = function (settings, callback) {
      const id = settings.id;
      const parent = '#' + id;

      $(settings.form).find(parent).remove();
      $(settings.form).append(`<div id="${id}" class="mb-3 picker"></div>`);

      $(parent).append(`<label class="form-label w-100">${settings.label}:
        <select class="filter-input task-status-select" name="${settings.name}[]" multiple="multiple"></select>
      </label>`);
      let status_select = $(parent).find(`.task-status-select`);
      for (let status of settings.options) {
        status_select.append(`
        <option value="${status.value}">
          ${status.label}
        </option>`)
      }
      status_select.select2({ width: '100%' });
      status_select.change(function (e) {
        let value = $(e.target).val().length > 0 ?
          `${$(e.target).val().length} ${declOfNum($(e.target).val().length, settings.titles)}` : //['статус', 'статуса', 'статусов']
          null;
        callback({
          parent: parent,
          name: 'status',
          value: value,
          label: `${settings.label}:`,
        });
      });
    }

    const createTaskStatusPicker = function (form, callback) {
      let options = [
        { value: 1, label: 'Новый' }, { value: 2, label: 'Ждет выполнения' },
        { value: 3, label: 'Выполняется' }, { value: 4, label: 'Предположительно завершено' },
        { value: 5, label: 'Завершена' }, { value: 6, label: 'Отложена' },
        { value: 7, label: 'Отклонено' }
      ];
      createSelect({
        form: form,
        id: 'task-status-picker',
        label: 'Статус задачи',
        name: 'status',
        titles: ['статус', 'статуса', 'статусов'],
        options: options
      }, callback);
    }

    const createUserPicker = async function (form, callback) {
      const id = 'user-picker';
      const parent = '#' + id;

      $(form).find(parent).remove();
      $(form).append(`<div id="${id}" class="mb-3 picker"></div>`);

      let res = await BX24Client.call('user.get', {});
      let users_list = res.data();
      while (res.more()) {
        res = await BX24Client.next(res);
        users_list = users_list.concat(res.data());
      }
      let options = users_list.map(e => ({ value: e.ID, label: e.NAME && e.LAST_NAME ? e.NAME + ' ' + e.LAST_NAME : 'Нет имени (id: ' + e.ID + ')' }));
      createSelect({
        form: form,
        id: 'user-picker',
        label: 'Ответственный',
        name: 'users',
        titles: ['пользователь', 'пользователя', 'пользователей'],
        options: options
      }, callback);
    }

    const createStatusPicker = async function (form, entity, callback) {
      const ENTITY_ID = ['STATUS', 'SOURCE'];
      if (!ENTITY_ID.includes(String(entity).toUpperCase())) throw 'This type of entity dont support!'
      let res = await BX24Client.call('crm.status.list', {
        order: { 'SORT': 'ASC' },
        filter: { 'ENTITY_ID': String(entity).toUpperCase() }
      });
      let status_list = res.data();
      while (res.more()) {
        res = await BX24Client.next(res);
        status_list = status_list.concat(res.data());
      }
      let options = status_list.map(e => ({ value: e.STATUS_ID, label: e.NAME || e.STATUS_ID }));
      createSelect({
        form: form,
        id: 'status-picker',
        label: 'Статус',
        name: 'status',
        titles: ['статус', 'статуса', 'статусов'],
        options: options
      }, callback);
    }

    const createIdPicker = function (form, callback) {
      const id = 'id-picker';
      const parent = '#' + id;

      $(form).find(parent).remove();
      $(form).append(`<div id="${id}" class="mb-3 picker"></div>`);

      $(parent).append(`<label class="form-label w-100">Идентификатор:
        <div class="d-flex">
          <label class="form-label text-start my-auto mx-2" for="min_id">От:</label>
          <input type="number" name="min_id" class="filter-input form-control" min="0">
          <label class="form-label text-start my-auto mx-2" for="max_id">До:</label>
          <input type="number" name="max_id" class="filter-input form-control" min="0">
        </div>
      </label>`);
      let min_id = $('input[name="min_id"]');
      let max_id = $('input[name="max_id"]');
      min_id.change(function (e) {
        max_id.attr('min', $(e.target).val());
      });
      max_id.change(function (e) {
        min_id.attr('max', $(e.target).val());
      });

      $(parent + ' .filter-input').change(function (e) {
        let label = $(parent + ' label[for="' + $(e.target).attr('name') + '"]').text();
        callback({
          parent: parent,
          name: $(e.target).attr('name'),
          value: $(e.target).val(),
          label: label,
        });
      });
    }

    const createDatePicker = function (form, callback) {
      const id = 'date-picker';
      const parent = '#' + id;

      $(form).find(parent).remove();
      $(form).append(`<div id="${id}" class="mb-3 picker"></div>`);

      $(parent).append(`<label class="form-label w-100">Дата создания:
        <div class="d-flex">
          <label class="form-label text-start my-auto mx-2" for="start_date">Начальная: </label>
          <input type="text" name="start_date" class="filter-input form-control" readonly>
          <label class="form-label text-start my-auto mx-2" for="end_date">Конечная: </label>
          <input type="text" name="end_date" class="filter-input form-control" readonly>
        </div>
      </label>`);
      let startDatePicker = new AirDatepicker(parent + ' input[name="start_date"]', {
        minDate: new Date(1),
        buttons: ['clear'],
        multipleDates: false,
        dateFormat(date) {
          return date2str(date);
        },
        onSelect({ date }) {
          endDatePicker.update({
            minDate: date,
          });
          let value = date ? date2str(date) : null;
          callback({
            parent: parent,
            name: "start_date",
            value: value,
            label: 'Начальная:',
          });
        }
      });
      let endDatePicker = new AirDatepicker(parent + ' input[name="end_date"]', {
        maxDate: dateInMoscow(),
        buttons: ['clear'],
        multipleDates: false,
        dateFormat(date) {
          return date2str(date);
        },
        onSelect({ date }) {
          startDatePicker.update({
            maxDate: date,
          });
          let value = date ? date2str(date) : null;
          callback({
            parent: parent,
            name: "end_date",
            value: value,
            label: 'Конечная:',
          });
        }
      });
      return { start: startDatePicker, end: endDatePicker };
    }

    const createNamePicker = function (form, callback) {
      const id = 'name-picker';
      const parent = '#' + id;

      $(form).find(parent).remove();
      $(form).append(`<div id="${id}" class="mb-3 picker"></div>`);

      $(parent).append(`<label class="form-label" for="title">Название содержит:</label><input type="text" name="title" class="filter-input form-control">`);
      $(parent + ' .filter-input').change(function (e) {
        let label = $(parent + ' label[for="' + $(e.target).attr('name') + '"]').text();
        callback({
          parent: parent,
          name: $(e.target).attr('name'),
          value: $(e.target).val(),
          label: label,
        });
      });
    }

    /**
     * Блок с инициализацией приложения и работой после прогрузки страницы
     **/
    $(document).ready(async function () {
      const APP = '#app',
        FORM = '#filter-form',
        SELECT_TYPE = '#select-entity',
        FILTER = '#filter',
        FILTER_MENU = '#filter-menu';
      /**
       * Эта функция передается в качестве обработчика нажатий на все пикеры, описанные в прошлом блоке
       * @param data = {
       *    parent: String, //общий враппер, указанный при создании
       *    name: String, //name атрибут инпута
       *    value: String || Array || Integer.., //значение
       *    label: String //значение лейбла, у которого в for указан нейм инпута
       * }
       **/
      function callback(data) {
        if (!data) return;
        let parent = $(FILTER).find('.filter-card[data-target="' + data.parent + '"]');
        parent.find('#' + data.name + '-wrapper').remove();
        if (data.value) {
          parent.append(`<div id="${data.name}-wrapper" class="input-wrapper px-1 mx-1 my-auto badge text-bg-primary">
            <span class="label-wrapper">${data.label || 'Не задан'}</span>
            <span class="value-wrapper">${data.value}</span>
          </div>`);
        }
        updateData($(SELECT_TYPE).val(), $(FORM).serializeObject());
        //при вводе данных фильтр становится больше и требуется изменение размера
        BX24.resizeWindow($(APP).width(), $(APP).height(), (result) => { BX24.fitWindow(); });
      }

      /**
       * Эта функция вызываетася каждый раз при изменении каких-то пользовательских данных
       * @param type String
       * @param query Object like {
       *    'users[]': [], //unset if empty
       *    title: String,
       *    min_id: String,
       *    max_id: max_id,
       *    start_date: String (like dd.mm.yyyy),
       *    end_date: String (like dd.mm.yyyy),
       *    'status[]': [], //unset if empty
       * }
       **/
      async function updateData(type, query) {
        $('.filter-button').prop('disabled', true);

        const entity = ENTITIES.find(e => e.name === type);
        if (!entity) throw 'Unknow type of entity!';
        let __filter = entity.serialize(query), __client = entity.new();
        let count = await __client.count({ filter: __filter });

        $('.entity-type').text(entity.label);
        $('.entity-count').text(count);
        $('.filter-button').prop('disabled', false);
      }

      $(SELECT_TYPE).change(function () {
        const type = $(this).val();
        $(FORM).empty();
        $('.filter-card').empty();
        $(FILTER_MENU).collapse('hide');
        if (type === 'lead') {
          createIdPicker(FORM, callback);
          createDatePicker(FORM, callback);
          createUserPicker(FORM, callback);
          createNamePicker(FORM, callback);
          createStatusPicker(FORM, 'STATUS', callback);
        } else if (type === 'task') {
          createIdPicker(FORM, callback);
          createDatePicker(FORM, callback);
          createUserPicker(FORM, callback);
          createNamePicker(FORM, callback);
          createTaskStatusPicker(FORM, callback)
        } else if (type === 'company') {
          createIdPicker(FORM, callback);
          createDatePicker(FORM, callback);
          createUserPicker(FORM, callback);
          createNamePicker(FORM, callback);
        } else return;
        updateData(type, $(FORM).serializeObject());
      });

      $(FILTER_MENU).on('shown.bs.collapse hidden.bs.collapse', function (e) {
        BX24.resizeWindow($(APP).width(), $(APP).height(), (result) => { BX24.fitWindow(); });
      })

      $(SELECT_TYPE).trigger('change');
    });
  </script>
</body>

</html>