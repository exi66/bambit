<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="//api.bitrix24.com/api/v1/"></script>
  <script src="https://dev.bambit.ru/burul/resources/js/jquery-3.6.1.min.js"></script>
  <script src="https://dev.bambit.ru/burul/resources/js/bx-24-wrapper.js"></script>
  <script src="https://dev.bambit.ru/burul/resources/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="./js/select2.min.js"></script>
  <script src="./js/air-datepicker.min.js"></script>

  <link rel="stylesheet" href="./css/select2.min.css">
  <link rel="stylesheet" href="./css/air-datepicker.min.css">
  <link rel="stylesheet" href="https://dev.bambit.ru/burul/resources/bootstrap/css/bootstrap.min.css">

  <style>
    #filter {
      min-height: 3.25rem;
    }

    .select2-selection__choice__remove {
      float: right;
      margin-right: 0.25rem !important;
      margin-left: 0.25rem !important;
    }

    .remove_from_filter {
      cursor: pointer;
    }

    .open-path {
      cursor: pointer;
    }

    .page-link:disabled {
      opacity: 0%;
    }

    .goto-page {
      width: 3.5rem !important;
    }

    .goto-prev {
      width: 3.5rem !important;
    }

    .goto-first {
      width: 3.5rem !important;
    }

    .goto-next {
      width: 3.5rem !important;
    }

    .goto-last {
      width: 3.5rem !important;
    }

    .th-sort-table {
      -webkit-user-select: none;
      /* Safari */
      -ms-user-select: none;
      /* IE 10 and IE 11 */
      user-select: none;
      /* Standard syntax */
      cursor: pointer;
    }

    .th-sort-table:hover {
      background-color: rgba(160, 190, 255, 0.5);
    }

    .th-sort-table.active {
      background-color: rgba(10, 88, 200, 0.3);
    }

    .th-sort-table.active.forward:after {
      display: inline-block;
      margin-left: 0.255em;
      vertical-align: 0.255em;
      content: "";
      border-top: 0.3em solid;
      border-right: 0.3em solid transparent;
      border-bottom: 0;
      border-left: 0.3em solid transparent;
    }

    .th-sort-table.active.reverse:after {
      display: inline-block;
      margin-left: 0.255em;
      vertical-align: 0.255em;
      content: "";
      border-top: 0;
      border-right: 0.3em solid transparent;
      border-bottom: 0.3em solid;
      border-left: 0.3em solid transparent;
    }

    .user-avatar {
      width: 2rem;
      height: 2rem;
      background-color: black;
    }

    .preloader {
      position: relative;
      display: block;
      margin: 0 auto 50px auto;
      width: 247px;
      height: 280px;
      background: #fff;
    }

    .arrows {
      position: absolute;
      top: 19px;
      left: 20px;
      display: inline-block;
      width: 210px;
      height: 210px;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjA3IDIwNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNDQuMjcgMTgxLjczNGMzMC42MTEgMjMuMDA3IDczLjIyMyAyNi45MjUgMTA4LjQ4IDYuNTcgMzUuNi0yMC41NTQgNTMuNTE1LTU5Ljk3MyA0OC40MS05OC4zMzhhMi40MDcgMi40MDcgMCAwIDEgNC40NTctLjYzMWM1LjM1NCA0MC4xMjktMTMuMzggODEuMzY3LTUwLjYxNyAxMDIuODY2LTM2LjczOCAyMS4yMS04MS4xMTMgMTcuMjE3LTExMy4wOTgtNi42MTdsMS45NzkgMTEuMjIzYTIuMDYzIDIuMDYzIDAgMSAxLTQuMDY0LjcxN2wtMi44NTMtMTYuMTgxYTIuMDU4IDIuMDU4IDAgMCAxIC4wMDctLjc1NiAyLjA1NiAyLjA1NiAwIDAgMSAxLjY5OS0yLjA0bDE2LjI2OS0yLjg3YTIuMDU2IDIuMDU2IDAgMSAxIC43MTQgNC4wNWwtMTEuMzg0IDIuMDA3ek0xNjAuMTMgMjIuMzc3QzEyOS43MzUgMS4wNTggODguNTItMi4wODkgNTQuMjUgMTcuNjk3Yy0zNC45IDIwLjE1LTUyLjgwNSA1OC40My00OC42ODQgOTYuMDc1YTIuNDA3IDIuNDA3IDAgMCAxLTQuNDI4LjkwMkMtMy4zNDggNzUuMTc4IDE1LjM3OCAzNC45NDMgNTIgMTMuNzk5YzM1LjkwMS0yMC43MjcgNzkuMDkzLTE3LjM4NiAxMTAuODkyIDUuMDE4bC0yLjI1NC0xMS41OTJhMi4wNjMgMi4wNjMgMCAxIDEgNC4wNS0uNzg3bDMuMTM2IDE2LjEyOGMuMDUuMjU4LjA1LjUxMy4wMDYuNzU2YTIuMDU2IDIuMDU2IDAgMCAxLTEuNjYzIDIuMDdsLTE2LjIxNiAzLjE1MmEyLjA1NiAyLjA1NiAwIDAgMS0uNzg1LTQuMDM2bDEwLjk2My0yLjEzeiIgZmlsbD0iI0E2RUFGRSIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+');
      background-repeat: no-repeat;
      opacity: 1;
    }

    @keyframes mercury-group {
      0% {
        transform: rotateZ(-360deg);
      }

      100% {
        transform: rotateZ(0deg);
      }
    }

    .arrows {
      animation: mercury-group 5s linear infinite;
    }

    .search {
      position: absolute;
      top: 58px;
      left: 31px;
      display: inline-block;
      width: 198px;
      height: 170px;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTk2IDE3MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PGRlZnM+PHJlY3QgaWQ9ImIiIHk9IjYiIHdpZHRoPSI2OSIgaGVpZ2h0PSI2MiIgcng9IjUiLz48ZmlsdGVyIHg9Ii0xOS42JSIgeT0iLTE2LjklIiB3aWR0aD0iMTM5LjElIiBoZWlnaHQ9IjE0My41JSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iYSI+PGZlT2Zmc2V0IGR5PSIzIiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0T3V0ZXIxIi8+PGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iNCIgaW49InNoYWRvd09mZnNldE91dGVyMSIgcmVzdWx0PSJzaGFkb3dCbHVyT3V0ZXIxIi8+PGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwLjA3NDQzNzI4MTUgMCIgaW49InNoYWRvd0JsdXJPdXRlcjEiLz48L2ZpbHRlcj48cGF0aCBkPSJNMjguNDM0IDBoOTIuNDA3YTUgNSAwIDAgMSA0Ljk5OCA1LjE1NmwtMS43NiA1Ni4zMDdhNSA1IDAgMCAxLTIuMTc0IDMuOTdMMTA1IDc3SDY0TDI3LjE3MiAzNy4yNjVhNSA1IDAgMCAxLTEuMzE1LTIuOTg0TDIzLjQ1IDUuNDE1QTUgNSAwIDAgMSAyOC40MzQgMHoiIGlkPSJkIi8+PGZpbHRlciB4PSItMTIuNyUiIHk9Ii0xMy42JSIgd2lkdGg9IjEyNS42JSIgaGVpZ2h0PSIxMzUuMSUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImMiPjxmZU9mZnNldCBkeT0iMyIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd09mZnNldE91dGVyMSIvPjxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjQiIGluPSJzaGFkb3dPZmZzZXRPdXRlcjEiIHJlc3VsdD0ic2hhZG93Qmx1ck91dGVyMSIvPjxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMC4zMDU3NTI4NDEgMCIgaW49InNoYWRvd0JsdXJPdXRlcjEiLz48L2ZpbHRlcj48cmVjdCBpZD0iZiIgeD0iNTUiIHk9IjciIHdpZHRoPSI1NyIgaGVpZ2h0PSI1NyIgcng9IjUiLz48ZmlsdGVyIHg9Ii0xNy41JSIgeT0iLTE0JSIgd2lkdGg9IjEzNS4xJSIgaGVpZ2h0PSIxMzUuMSUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImUiPjxmZU9mZnNldCBkeT0iMiIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd09mZnNldE91dGVyMSIvPjxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjMiIGluPSJzaGFkb3dPZmZzZXRPdXRlcjEiIHJlc3VsdD0ic2hhZG93Qmx1ck91dGVyMSIvPjxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMC4xNzk0Njg5NjkgMCIgaW49InNoYWRvd0JsdXJPdXRlcjEiLz48L2ZpbHRlcj48cGF0aCBkPSJNNSAwaDUxLjdhNSA1IDAgMCAxIDMuNzk3IDEuNzQ2TDc3IDIxdjUwYTUgNSAwIDAgMS01IDVINWE1IDUgMCAwIDEtNS01VjVhNSA1IDAgMCAxIDUtNXoiIGlkPSJoIi8+PGZpbHRlciB4PSItMTMlIiB5PSItMTAuNSUiIHdpZHRoPSIxMjYlIiBoZWlnaHQ9IjEyNi4zJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZyI+PGZlT2Zmc2V0IGR5PSIyIiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0T3V0ZXIxIi8+PGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMyIgaW49InNoYWRvd09mZnNldE91dGVyMSIgcmVzdWx0PSJzaGFkb3dCbHVyT3V0ZXIxIi8+PGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwLjA5NTc0NDA5OTcgMCIgaW49InNoYWRvd0JsdXJPdXRlcjEiLz48L2ZpbHRlcj48cGF0aCBkPSJNNDUuOTE1IDQ1LjYyNGMtMjQuOTM1IDI0Ljk0LTI1LjA5OCA2NS40ODItLjE4OCA5MC4zOTkgMjQuOTEgMjQuOTE2IDY1LjQzNCAyNC43NiA5MC41MzYtLjM0NyAyNC45MzQtMjQuOTQgMjUuMjU3LTY1LjY0Mi4zNDctOTAuNTU4LTI0LjkwNC0yNC45MjMtNjUuNTk1LTI0LjYtOTAuNjk3LjUwOGwuMDAyLS4wMDJ6bTg0Ljk2NyA4NC45NDVjLTIyLjEyIDIyLjEyNS01OC4wNTggMjIuMjYzLTgwLjAxLjMwNy0yMS45NS0yMS45NTYtMjEuODEyLTU3LjkwNC4zMDctODAuMDI4IDIyLjEyLTIyLjEyNSA1OC4wNTktMjIuMjYzIDgwLjAxLS4zMDcgMjEuOTQ0IDIxLjk2MiAyMS44MDYgNTcuOTEtLjMwNyA4MC4wMjh6IiBpZD0iaiIvPjxmaWx0ZXIgeD0iLTEwLjIlIiB5PSItNi4zJSIgd2lkdGg9IjEyMC4zJSIgaGVpZ2h0PSIxMjAuMyUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImkiPjxmZU9mZnNldCBkeT0iNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd09mZnNldE91dGVyMSIvPjxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjMuNSIgaW49InNoYWRvd09mZnNldE91dGVyMSIgcmVzdWx0PSJzaGFkb3dCbHVyT3V0ZXIxIi8+PGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwLjAwNzE4NDIyMjAzIDAiIGluPSJzaGFkb3dCbHVyT3V0ZXIxIi8+PC9maWx0ZXI+PC9kZWZzPjxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCA0OCkiPjx1c2UgZmlsbD0iIzAwMCIgZmlsdGVyPSJ1cmwoI2EpIiB4bGluazpocmVmPSIjYiIvPjx1c2UgZmlsbD0iI0EwRThGRiIgeGxpbms6aHJlZj0iI2IiLz48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCA0OCkiPjx1c2UgZmlsbD0iIzAwMCIgZmlsdGVyPSJ1cmwoI2MpIiB4bGluazpocmVmPSIjZCIvPjx1c2UgZmlsbD0iI0EwRThGRiIgeGxpbms6aHJlZj0iI2QiLz48L2c+PGcgb3BhY2l0eT0iLjUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE5IDU5KSIgZmlsbD0iIzJGQzZGNiI+PHJlY3QgdHJhbnNmb3JtPSJtYXRyaXgoLTEgMCAwIDEgMTcgMCkiIHk9IjMiIHdpZHRoPSIxNyIgaGVpZ2h0PSI1IiByeD0iMi41Ii8+PHJlY3QgdHJhbnNmb3JtPSJtYXRyaXgoLTEgMCAwIDEgMTQgMCkiIHk9IjEzIiB3aWR0aD0iMTQiIGhlaWdodD0iNSIgcng9IjIuNSIvPjxyZWN0IG9wYWNpdHk9Ii44ODMiIHk9IjM0IiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHJ4PSI2Ii8+PHJlY3Qgb3BhY2l0eT0iLjg4MyIgeD0iMTYiIHk9IjM0IiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHJ4PSI2Ii8+PHBhdGggZD0iTTI3LjgxIDQ1LjQ5M2MtNC4zMy0zLjAwMi03LjQ1Mi03LjY5Ni04LjQ2LTEzLjE1NmE4IDggMCAxIDEgOC40NiAxMy4xNTZ6IiBvcGFjaXR5PSIuODgzIi8+PHJlY3QgeD0iMTQiIHdpZHRoPSI0OS42NTciIGhlaWdodD0iNyIgcng9IjMuNSIvPjxyZWN0IHg9IjE0IiB5PSIxNCIgd2lkdGg9IjQ5LjY1NyIgaGVpZ2h0PSI3IiByeD0iMy41Ii8+PC9nPjxnPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDc0IDIwKSI+PHVzZSBmaWxsPSIjMDAwIiBmaWx0ZXI9InVybCgjZSkiIHhsaW5rOmhyZWY9IiNmIi8+PHVzZSBmaWxsPSIjQzVGMDNGIiB4bGluazpocmVmPSIjZiIvPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3NCAyMCkiPjx1c2UgZmlsbD0iIzAwMCIgZmlsdGVyPSJ1cmwoI2cpIiB4bGluazpocmVmPSIjaCIvPjx1c2UgZmlsbD0iI0M1RjAzRiIgeGxpbms6aHJlZj0iI2giLz48L2c+PGcgb3BhY2l0eT0iLjUzNiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODQgMzApIiBmaWxsPSIjOTRCODE3Ij48cmVjdCBvcGFjaXR5PSIuODgzIiB4PSIyIiB5PSIzOSIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiByeD0iOCIvPjxyZWN0IG9wYWNpdHk9Ii44ODMiIHg9IjI1IiB5PSIzOSIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiByeD0iOCIvPjxyZWN0IHg9IjMuNjU3IiB5PSIzIiB3aWR0aD0iNTkiIGhlaWdodD0iNyIgcng9IjMuNSIvPjxyZWN0IHg9IjMuNjU3IiB5PSIxNyIgd2lkdGg9IjY1IiBoZWlnaHQ9IjciIHJ4PSIzLjUiLz48cmVjdCB0cmFuc2Zvcm09Im1hdHJpeCgtMSAwIDAgMSAxNTAgMCkiIHg9IjYzIiB5PSI3IiB3aWR0aD0iMjQiIGhlaWdodD0iNSIgcng9IjIuNSIvPjxyZWN0IHRyYW5zZm9ybT0ibWF0cml4KC0xIDAgMCAxIDE1NC42ODYgMCkiIHg9IjY3LjM0MyIgeT0iMTciIHdpZHRoPSIyMCIgaGVpZ2h0PSI1IiByeD0iMi41Ii8+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InJvdGF0ZSgtNDUgNjIuNzUxIDc2LjQwOCkiPjxwYXRoIGQ9Ik05MC42MzkgMzIuNjE4Yy0yNC4xNDQgMC00My44NDYgOS44NDctNDMuODQ2IDIyczE5LjY5NCAyMiA0NCAyMmMyNC4xNDQgMCA0NC05Ljg0NyA0NC0yMiAuMDA2LTEyLjE1My0xOS44NS0yMi00NC4xNTYtMjJoLjAwMnoiIGZpbGw9IiNGRkYiIGZpbGwtcnVsZT0ibm9uemVybyIgb3BhY2l0eT0iLjQzNyIvPjxyZWN0IGZpbGw9IiMxMEFEREYiIHRyYW5zZm9ybT0ibWF0cml4KDEgMCAwIC0xIDAgMzI2KSIgeD0iODciIHk9IjE1MyIgd2lkdGg9IjkiIGhlaWdodD0iMjAiIHJ4PSI0LjUiLz48ZyBmaWxsLXJ1bGU9Im5vbnplcm8iIHRyYW5zZm9ybT0icm90YXRlKDQ1IDkxLjEyOSA5MC42MDkpIj48dXNlIGZpbGw9IiMwMDAiIGZpbHRlcj0idXJsKCNpKSIgeGxpbms6aHJlZj0iI2oiLz48dXNlIGZpbGw9IiMyRkM2RjYiIHhsaW5rOmhyZWY9IiNqIi8+PC9nPjxwYXRoIGQ9Ik05MC45ODIgMzIuODA4Yy0zMS45Ni4wMDQtNTguMDQ1IDI1Ljg3OS01OC4wNSA1Ny44MDktLjAwMyAzMS45MyAyNi4wNjUgNTcuNzk4IDU4LjI0IDU3Ljc5NCAzMS45Ni0uMDA0IDU4LjI1LTI1Ljg3OSA1OC4yNTMtNTcuODA5LjAxMi0zMS45My0yNi4yNy01Ny43OTgtNTguNDQ1LTU3Ljc5NGguMDAyem0uMDE0IDExMS44MTNjLTI5Ljk4LjAwMy01NC40MjQtMjQuMjU1LTU0LjQyLTU0LjAwNS4wMDMtMjkuNzUgMjQuNDU0LTU0LjAxNCA1NC40MzMtNTQuMDE4IDI5Ljk3OS0uMDAzIDU0LjQyNCAyNC4yNTUgNTQuNDIgNTQuMDA1LS4wMTIgMjkuNzUtMjQuNDYzIDU0LjAxNC01NC40MzMgNTQuMDE4eiIgZmlsbC1vcGFjaXR5PSIuNDE3IiBmaWxsPSIjQThBREI0IiBmaWxsLXJ1bGU9Im5vbnplcm8iIG9wYWNpdHk9Ii40MTgiLz48cmVjdCBmaWxsPSIjQThBREI0IiB4PSI4MiIgeT0iMTY4IiB3aWR0aD0iMTkiIGhlaWdodD0iNjIiIHJ4PSI2Ii8+PHJlY3QgZmlsbD0iIzUyNUM2OSIgb3BhY2l0eT0iLjExNSIgeD0iODIiIHk9IjE2OCIgd2lkdGg9IjgiIGhlaWdodD0iNjIiIHJ4PSI0Ii8+PC9nPjwvZz48L3N2Zz4=');
      background-repeat: no-repeat;
      animation: crm-dedupe-wizard-start-icon-icon-animation .9s cubic-bezier(0.215, 0.61, 0.355, 1) forwards;
      opacity: 1;
      z-index: 3;
    }

    .circle {
      display: inline-block;
      width: 247px;
      height: 246px;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQ3IDI0NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIzLjUgMjQ2QzU1LjI5MyAyNDYgMCAxOTAuOTMyIDAgMTIzIDAgNTUuMDY5IDU1LjI5MiAwIDEyMy41IDAgMTkxLjcwNyAwIDI0NyA1NS4wNjkgMjQ3IDEyM2MwIDY3LjkzMi01NS4yOTMgMTIzLTEyMy41IDEyM3ptMC00M2M0NC40NTkgMCA4MC41LTM1LjgxNyA4MC41LTgwcy0zNi4wNDEtODAtODAuNS04MEM3OS4wNCA0MyA0MyA3OC44MTcgNDMgMTIzczM2LjA0MSA4MCA4MC41IDgweiIgZmlsbD0iIzlDRTdGRiIgZmlsbC1ydWxlPSJub256ZXJvIiBvcGFjaXR5PSIuMjEyIi8+PC9zdmc+');
      background-repeat: no-repeat;
      animation: mercury-group 5s linear infinite;
      opacity: 1;
    }

    #progressBar {
      margin: 0 auto 59px auto;
      width: 100%;
      max-width: 421px;
    }

    .progressbar-column .progressbar-text-after {
      padding: 0;
      color: #828b95;
      font-size: 12px;
      order: 5;
    }

    .progressbar-column .progressbar-text-before {
      padding: 0 0 3px;
      font-size: 14px;
      order: 1;
    }

    .progressbar-column .progressbar-status-percent {
      color: #333;
      font: 300 16px/20px "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
      order: 2;
    }

    .progressbar-status,
    .progressbar-status-percent,
    .progressbar-text-after,
    .progressbar-text-before {
      padding: 0 17px;
      color: #535c69;
      font: 13px/16px "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .progressbar-column .progressbar-track {
      margin: 11px 0 9px;
      order: 3;
    }

    .progressbar-track {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background-color: #edeef0;
      transition: 250ms linear all;
      order: 2;
      flex: 1;
    }

    .progressbar-bar {
      height: 8px;
      border-radius: 4px;
      background-color: #9dcf00;
      transition: 120ms linear width;
    }

    .crm-dedupe-wizard-start-control-box {
      margin-bottom: 37px;
      height: 39px;
      width: 100%;
      text-align: center;
    }
  </style>

  <title>app</title>
</head>

<body>
  <main id="app" class="container-fluid">
    <div class="row d-flex justify-content-center">
      <div class="col-5 row">
        <div class="col-12">
          <h1>Удаление записей</h1>
        </div>
        <div class="col-12 my-3">
          <h2>Тип</h2>
          <select id="select-entity" class="form-select form-select-lg">
            <option value="lead" selected>Лиды</option>
            <option value="task">Задачи</option>
            <option value="company">Компании</option>
          </select>
        </div>
        <div class="col-12 my-3">
          <h2>Фильтр</h2>
          <div id="filter" class="form-select form-select-lg form-select-filter" data-bs-toggle="dropdown"
            data-bs-auto-close="outside" aria-expanded="false">
            <div class="row" id="filter-cards-wrapper">

            </div>
          </div>
          <div class="position-relative m-0 p-0">
            <div class="dropdown-menu w-100" style="z-index: 50;" id="filter-menu" aria-labelledby="filter">
              <form class="p-4 w-100" id="filter-form" data-target="#filter"></form>
            </div>
          </div>
        </div>
        <div class="col-12 my-3">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Тип: <span class="entity-type">Лид</span></h3>
              <div class="row my-1">
                <div class="col my-auto">
                  <p class="card-text">Найдено: <span class="entity-count">0</span></p>
                </div>
                <div class="col-auto ms-auto">
                  <button id="show-table" class="btn btn-primary filter-button" disabled>Посмотреть</button>
                </div>
              </div>
              <div class="d-grid">
                <button id="delete-all" class="btn btn-danger filter-button" disabled>Удалить все</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="confirm" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-labelledby="confirm-title" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="confirm-title">Подтверждение</h3>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary confirm-yes">Подтвердить</button>
            <button type="button" class="btn btn-danger confirm-no">Отменить</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="loader" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-labelledby="loader-title" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="loader-title">Загрузка...</h3>
          </div>
          <div class="modal-body">
            <div class="preloader">
              <div class="">
                <div class="arrows">
                </div>
                <div class="search">
                </div>
                <div class="circle">
                </div>
              </div>
              <div class="crm-dedupe-wizard-start-control-box">
                <div id="progressBar" class="crm-dedupe-wizard-status-bar">
                  <div class="progressbar progressbar-success progressbar-column">
                    <div class="progressbar-status-percent">Поиск</div>
                    <div class="progressbar-text-after"></div>
                    <div class="progressbar-text-before"></div>
                    <div class="progressbar-track">
                      <div class="progressbar-bar"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="cancel-req" disabled>Отменить</button>
          </div>
        </div>
      </div>
    </div>
    <div class="offcanvas offcanvas-end w-75 border-0 my-3" tabindex="-1" id="filter-offcanvas"
      aria-labelledby="slider-title">
      <div class="offcanvas-header justify-content-start">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        <h3 id="slider-title" class="my-auto ms-3">Результаты поиска</h3>
      </div>
      <div class="offcanvas-body">
        <p class="fw-bold">
          Найдено: <span class="entity-count">0</span>
        </p>
        <div class="pagination-wrapper"></div>
        <div class="table-responsive">
          <table id="filter-table" class="table table-bordered table-hover align-middle">
            <thead>
              <tr class="sort-wrapper">
                <th scope="col" class="th-sort-table active reverse" data-target="id" data-type="integer"
                  style="width: 10%;">ID</th>
                <th scope="col" class="th-sort-table" data-target="title" data-type="string" style="width: 30%;">
                  Название</th>
                <th scope="col" class="th-sort-table" data-target="user" data-type="string" style="width: 30%;">
                  Ответственный</th>
                <th scope="col" class="th-sort-table" data-target="created" data-type="date" style="width: 20%;">Дата
                  создания</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">1</th>
                <td>Заголовок</td>
                <td>Пользователь</td>
                <td>11.11.2022</td>
                <th style="width: 7rem" class="text-center"><button type="button"
                    class="btn btn-danger btn-sm">Удалить</button></th>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination-wrapper"></div>
      </div>
    </div>
  </main>
  <script>
    const BX24Client = new BX24Wrapper();
    BX24.init(BX24.getAuth());

    class Entities {
      //?надо так же переделать в класс?
      /** @property methods
       * must be a Object like:
       * methods = {
       *   list: { //list method
       *     method: 'tasks.task.list',
       *     filter: ... //default filter if needed
       *     select: ... //default select if needed (dont forgot about ID if u set this param, this is required)
       *   },
       *   delete: { //delete method
       *     method: 'tasks.task.delete',
       *     param: 'taskId', //required id field name for method
       *   }
       * }
       **/
      constructor(methods) {
        if (!methods instanceof Object) {
          throw 'methods prop must be a Object!'
        }
        this.methods = methods;
        this.client = BX24Client;
        this.entityList;
        this.operationTimeout = 450;
        this.timeoutDuration = 120 * 1000;
      }
      timeout(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
      async getTest(settings) {
        let count = await this.count(settings);
        if (!count) return;
        let __method = settings.method || this.methods.list.method,
          id__wrapper = settings.id_wrapper || this.methods.list.id_wrapper,
          __wrapper = settings.wrapper || this.methods.list.wrapper,
          __filter = settings.filter || this.methods.list.filter,
          __select = settings.select || this.methods.list.select,
          __callback = settings.callback || function () { return { cancel: false } },
          __timeout = settings.timeout || function () { };
        if (!__select.includes('ID')) __select.push('ID');
        let last_id = __filter['>ID'] || 0, data = [], duration = 0;
        while (count > 0) {
          let local_filter = JSON.parse(JSON.stringify(__filter));
          local_filter['>ID'] = last_id;
          let local_count = Math.min(Math.ceil(count / 50), 50), calls = [{
            method: __method,
            params: {
              order: settings.order || { 'ID': 'ASC' },
              filter: local_filter,
              select: __select,
              start: -1,
            }
          }]
          for (let i = 1; i < local_count; i++) {
            let local_filter = JSON.parse(JSON.stringify(__filter));
            local_filter['>ID'] = `$result[${i - 1}]${__wrapper ? '[' + __wrapper + ']' : ''}[49][${id__wrapper}]`;
            calls[i] = {
              method: __method,
              params: {
                order: settings.order || { 'ID': 'ASC' },
                filter: local_filter,
                select: __select,
                start: -1,
              }
            }
          }
          let now = new Date().getTime();
          let res = await this.client.callBatch(calls);
          now = (new Date().getTime() - now) / 1000;
          res.time = now;
          duration += now;
          for (let r of res) {
            if (r.error()) throw 'Batch error!'
            data = data.concat(__wrapper ? r.data()[__wrapper] : r.data());
          }
          if (__callback(res, data.length).cancel) throw 'Cancel';
          if (duration >= this.operationTimeout) {
            __timeout(res, data.length);
            await this.timeout(this.timeoutDuration);
            duration = 0;
          }
          last_id = data[data.length - 1][id__wrapper];
          count -= 2500;
        }
        return data;
      }
      async get(settings) {
        let __method = settings.method || this.methods.list.method,
          __wrapper = settings.wrapper || this.methods.list.wrapper,
          __filter = settings.filter || this.methods.list.filter,
          __select = settings.select || this.methods.list.select,
          __callback = settings.callback || function () { return { cancel: false } };
        if (!__filter || !__method) return;
        let res = await this.client.call(__method, {
          order: settings.order || { 'ID': 'ASC' },
          filter: __filter,
          select: __select || ['ID'],
          start: -1,
        });
        if (res.error()) throw 'Request error: ' + res.error();
        let local_entityList = __wrapper ? res.data()[__wrapper] : res.data();
        if (__callback(res, local_entityList.length).cancel) throw 'Cancel';
        while (res.more()) {
          res = await this.client.next(res);
          if (res.error()) throw 'Request error: ' + res.error();
          local_entityList = local_entityList.concat(__wrapper ? res.data()[__wrapper] : res.data());
          if (__callback(res, local_entityList.length).cancel) throw 'Cancel';
        }
        return this.entityList = local_entityList;
      }
      async count(settings) {
        let __method = settings.method || this.methods.list.method, __filter = settings.filter || this.methods.list.filter;
        if (!__method) return;
        let res = await this.client.call(__method, {
          order: { 'ID': 'ASC' },
          filter: __filter,
          select: ['ID'],
        });
        if (res.error()) throw 'Request error: ' + res.error();
        return res.total();
      }
      async deleteAll(settings) {
        if (!settings.entityList) return;
        let local_entityList = JSON.parse(JSON.stringify(settings.entityList)),
          result = [],
          length = 50,
          __callback = settings.callback || function () { return { cancel: false } };
        while (local_entityList.length) result.push(local_entityList.splice(0, length));
        let cmds = [];
        for (let page of result) {
          cmds.push(page.map(e => ({
            method: this.methods.delete.method,
            params: { [this.methods.delete.param]: e.id }
          })));
        }
        let count = 0, duration = 0;
        for (let i = 0; i < cmds.length; i++) {
          let now = new Date().getTime();
          let res = await this.client.callBatch(cmds[i]);
          now = (new Date().getTime() - now) / 1000;
          res.time = now;
          duration += now;
          count += res.length;
          if (__callback(res, count).cancel) throw 'Cancel';
          if (duration >= this.operationTimeout) {
            __timeout(res, data.length);
            await this.timeout(this.timeoutDuration);
            duration = 0;
          }
        }
      }
      async delete(settings) {
        let __method = settings.method || this.methods.delete.method,
          __id = settings.id,
          __param = settings.param || this.methods.delete.param;
        if (!__method || !__id || !__param) return;
        let res = await this.client.call(__method, { [__param]: __id });
        if (res.error()) throw 'Request error: ' + res.error();
        return res.data();
      }

    }
    //пример использования
    // async function () {
    //   let a = new Entities({
    //     list: {
    //       method: 'crm.lead.list',
    //     },
    //     delete: {
    //       method: 'crm.lead.delete',
    //       param: 'id',
    //     }
    //   });

    //   let b = await a.get({ filter: { 'ASSIGNED_BY_ID': 92 } });
    //   console.log(b);
    // }

    //каждый из методов объекта представляет из себя соотвествующий своему типу преобразователь данных формы в filter для list метода
    //?переделать в класс?
    /** @param query
     * must be like obj {
     *    'users[]': [], //unset if empty
     *    title: String,
     *    min_id: String,
     *    max_id: max_id,
     *    start_date: String (like dd.mm.yyyy),
     *    end_date: String (like dd.mm.yyyy),
     *    'status[]': [], //unset if empty
     * }
     **/
    const SERIALIZE = {
      serializeLead: function (query) {
        let ___filter = {};
        if (query['users[]']) ___filter.ASSIGNED_BY_ID = query['users[]'];
        if (query.title) ___filter['%TITLE'] = query.title;
        if (query.min_id) ___filter['>ID'] = parseInt(query.min_id);
        if (query.max_id) ___filter['<ID'] = parseInt(query.max_id);
        if (query.start_date) ___filter['>DATE_CREATE'] = this.date2str(query.start_date) + 'T00:00:00';
        if (query.end_date) ___filter['<DATE_CREATE'] = this.date2str(query.end_date) + 'T23:59:59';
        if (query['status[]']) ___filter.STATUS_ID = query['status[]'];
        return ___filter;
      },
      serializeCompany: function (query) {
        let ___filter = {};
        if (query['users[]']) ___filter.ASSIGNED_BY_ID = query['users[]'];
        if (query.title) ___filter['%TITLE'] = query.title;
        if (query.min_id) ___filter['>ID'] = parseInt(query.min_id);
        if (query.max_id) ___filter['<ID'] = parseInt(query.max_id);
        if (query.start_date) ___filter['>DATE_CREATE'] = this.date2str(query.start_date) + 'T00:00:00';
        if (query.end_date) ___filter['<DATE_CREATE'] = this.date2str(query.end_date) + 'T23:59:59';
        return ___filter;
      },
      serializeTask: function (query) {
        let ___filter = {};
        if (query['users[]']) ___filter.RESPONSIBLE_ID = query['users[]'];
        if (query.title) ___filter['%TITLE'] = query.title;
        if (query.min_id) ___filter['>ID'] = parseInt(query.min_id);
        if (query.max_id) ___filter['<ID'] = parseInt(query.max_id);
        if (query.start_date) ___filter['>CREATED_DATE'] = this.date2str(query.start_date) + 'T00:00:00';
        if (query.end_date) ___filter['<CREATED_DATE'] = this.date2str(query.end_date) + 'T23:59:59';
        if (query['status[]']) ___filter.REAL_STATUS = query['status[]'];
        return ___filter;
      },
      //вспомогательные функции
      date2str: function (date_string) {
        let tmp = date_string.split('.');
        let d = new Date(tmp[2] + '-' + tmp[1] + '-' + tmp[0]);
        return d.getFullYear() + '-' + this.paddatepart(1 + d.getMonth()) + '-' + this.paddatepart(d.getDate());
      },
      paddatepart: function (part) {
        return part >= 10 ? part.toString() : '0' + part.toString();
      }
    }

    //делает обратное
    const TABLE = {
      serializeLead: function (array) {
        return array.map(function (e) {
          if (!e.ID) return;
          let elem = {};
          elem.id = e.ID;
          if (e.TITLE) elem.title = e.TITLE;
          if (e.ASSIGNED_BY_ID) elem.user = e.ASSIGNED_BY_ID;
          if (e.DATE_CREATE) elem.created = e.DATE_CREATE;
          return elem;
        });
      },
      serializeTask: function (array) {
        return array.map(function (e) { //e => ({ id: e.id, title: e.title, user: e.responsibleId, created: e.createdDate }))
          if (!e.id) return;
          let elem = {};
          elem.id = e.id;
          if (e.title) elem.title = e.title;
          if (e.responsibleId) elem.user = e.responsibleId;
          if (e.createdDate) elem.created = e.createdDate;
          return elem;
        });
      },
    }

    const FIELDS = {
      users: [],
      form: '#filter-form',
      callback: function () { },
      createTaskStatusPicker: function () {
        let options = [
          { value: 1, label: 'Новый' }, { value: 2, label: 'Ждет выполнения' },
          { value: 3, label: 'Выполняется' }, { value: 4, label: 'Предположительно завершено' },
          { value: 5, label: 'Завершена' }, { value: 6, label: 'Отложена' },
          { value: 7, label: 'Отклонено' }
        ];
        this.createSelect({
          form: this.form,
          id: 'task-status-picker',
          label: 'Статус задачи',
          name: 'status',
          titles: ['статус', 'статуса', 'статусов'],
          options: options
        });
      },
      createUserPicker: async function () {
        let options = this.users.map(e => ({ value: e.id, label: e.name }));
        this.createSelect({
          form: this.form,
          id: 'user-picker',
          label: 'Ответственный',
          name: 'users',
          titles: ['пользователь', 'пользователя', 'пользователей'],
          options: options
        });
      },
      createStatusPicker: async function () {
        let res = await BX24Client.call('crm.status.list', {
          order: { 'SORT': 'ASC' },
          filter: { 'ENTITY_ID': 'STATUS' }
        });
        let status_list = res.data();
        while (res.more()) {
          res = await BX24Client.next(res);
          status_list = status_list.concat(res.data());
        }
        let options = status_list.map(e => ({ value: e.STATUS_ID, label: e.NAME || e.STATUS_ID }));
        this.createSelect({
          form: this.form,
          id: 'status-picker',
          label: 'Статус',
          name: 'status',
          titles: ['статус', 'статуса', 'статусов'],
          options: options
        });
      },
      createIdPicker: function () {
        const self = this, id = 'id-picker', parent = '#' + id;

        $(this.form).find(parent).remove();
        $(this.form).append(`<div id="${id}" class="mb-3 picker"></div>`);

        $(parent).append(`<label class="form-label w-100">Идентификатор:
        <div class="row">
          <div class="col-6">
            <label class="form-label mx-2" for="min_id">От:</label>
            <input type="number" name="min_id" class="filter-input form-control" min="0">
          </div>
          <div class="col-6">
            <label class="form-label mx-2" for="max_id">До:</label>
            <input type="number" name="max_id" class="filter-input form-control" min="0">
          </div>
        </div>
      </label>`);
        let min_id = $('input[name="min_id"]');
        let max_id = $('input[name="max_id"]');
        min_id.change(function (e) {
          max_id.attr('min', $(e.target).val());
        });
        max_id.change(function (e) {
          min_id.attr('max', $(e.target).val());
        });

        $(parent + ' .filter-input').change(function (e) {
          let label = $(parent + ' label[for="' + $(e.target).attr('name') + '"]').text();
          self.callback({
            parent: parent,
            name: $(e.target).attr('name'),
            value: $(e.target).val(),
            label: label,
          });
        });
      },
      createDatePicker: function () {
        const self = this, id = 'date-picker', parent = '#' + id;

        $(this.form).find(parent).remove();
        $(this.form).append(`<div id="${id}" class="mb-3 picker"></div>`);

        $(parent).append(`<label class="form-label w-100">Дата создания:
          <div class="row">
            <div class="col-6">
              <label class="form-label text-start mx-2" for="start_date">Начальная: </label>
              <input type="text" name="start_date" class="filter-input form-control" pattern="[0-9]{1,2}.[0-9]{1,2}.[0-9]{4}">
            </div>
            <div class="col-6">
              <label class="form-label text-start mx-2" for="end_date">Конечная: </label>
              <input type="text" name="end_date" class="filter-input form-control" pattern="[0-9]{1,2}.[0-9]{1,2}.[0-9]{4}">
            </div>
          </div>
        </label>`);
        let startDatePicker = new AirDatepicker(parent + ' input[name="start_date"]', {
          minDate: new Date(1),
          buttons: ['clear'],
          multipleDates: false,
          dateFormat(date) {
            return self.date2str(date);
          },
          onSelect({ date }) {
            endDatePicker.update({
              minDate: date,
            });
            let value = date ? self.date2str(date) : null;
            self.callback({
              parent: parent,
              name: "start_date",
              value: value,
              label: 'Начальная:',
            });
          }
        });
        let endDatePicker = new AirDatepicker(parent + ' input[name="end_date"]', {
          maxDate: this.dateInMoscow(),
          buttons: ['clear'],
          multipleDates: false,
          dateFormat(date) {
            return self.date2str(date);
          },
          onSelect({ date }) {
            startDatePicker.update({
              maxDate: date,
            });
            let value = date ? self.date2str(date) : null;
            self.callback({
              parent: parent,
              name: "end_date",
              value: value,
              label: 'Конечная:',
            });
          }
        });
        $(parent).find('input[name="start_date"]').change(function (e) {
          if ($(this).val() == 0) startDatePicker.clear({ silent: false });
          else if (this.checkValidity()) {
            let date = $(this).val().split('.');
            let d = Date.parse(self.paddatepart(date[1]) + '-' + self.paddatepart(date[0]) + '-' + date[2]);
            if (isNaN(d)) return;
            startDatePicker.selectDate(new Date(self.paddatepart(date[1]) + '-' + self.paddatepart(date[0]) + '-' + date[2]), { silent: false });
          }
        });
        $(parent).find('input[name="end_date"]').change(function (e) {
          if ($(this).val() == 0) endDatePicker.clear({ silent: false });
          else if (this.checkValidity()) {
            let date = $(this).val().split('.');
            let d = Date.parse(self.paddatepart(date[1]) + '-' + self.paddatepart(date[0]) + '-' + date[2]);
            if (isNaN(d)) return;
            endDatePicker.selectDate(new Date(self.paddatepart(date[1]) + '-' + self.paddatepart(date[0]) + '-' + date[2]), { silent: false });
          }
        });
        $('#air-datepicker-global-container').click(function (e) {
          e.stopPropagation();
        });
        return { start: startDatePicker, end: endDatePicker };
      },
      createNamePicker: function () {
        const self = this, id = 'name-picker', parent = '#' + id;

        $(this.form).find(parent).remove();
        $(this.form).append(`<div id="${id}" class="mb-3 picker"></div>`);

        $(parent).append(`<label class="form-label" for="title">Название содержит:</label><input type="text" name="title" class="filter-input form-control">`);
        $(parent + ' .filter-input').change(function (e) {
          let label = $(parent + ' label[for="' + $(e.target).attr('name') + '"]').text();
          self.callback({
            parent: parent,
            name: $(e.target).attr('name'),
            value: $(e.target).val(),
            label: label,
          });
        });
      },
      //вспомогательные функции
      declOfNum: function (number, titles) {
        cases = [2, 0, 1, 1, 1, 2];
        return titles[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
      },
      date2str: function (d) {
        return this.paddatepart(d.getDate()) + '.' + this.paddatepart(1 + d.getMonth()) + '.' + d.getFullYear();
      },
      paddatepart: function (part) {
        return part >= 10 ? part.toString() : '0' + part.toString();
      },
      dateInMoscow: function () {
        return new Date(
          new Date().toLocaleString('en-US', { timeZone: 'Europe/Moscow' })
        );
      },
      createSelect: function (settings) {
        const self = this, id = settings.id, parent = '#' + id;

        $(settings.form).find(parent).remove();
        $(settings.form).append(`<div id="${id}" class="mb-3 picker"></div>`);

        $(parent).append(`<label class="form-label w-100">${settings.label}:
        <select class="filter-input task-status-select" name="${settings.name}[]" multiple="multiple"></select>
      </label>`);
        let status_select = $(parent).find(`.task-status-select`);
        for (let status of settings.options) {
          status_select.append(`
        <option value="${status.value}">
          ${status.label}
        </option>`)
        }
        status_select.select2({ width: '100%' });
        status_select.change(function (e) {
          let value = $(e.target).val().length > 0 ?
            `${$(e.target).val().length} ${self.declOfNum($(e.target).val().length, settings.titles)}` : null;
          self.callback({
            parent: parent,
            name: settings.name,
            value: value,
            label: `${settings.label}:`,
          });
        });
      },
    }

    const ENTITIES = [
      {
        name: 'lead',
        label: 'Лид',
        labels: ['лид', 'лида', 'лидов'],
        path: '/crm/lead/details/',
        entity: {},
        new: function () {
          if (this.entity instanceof Entities) return this.entity;
          return this.entity = new Entities({
            list: {
              select: ['ID', 'DATE_CREATE', 'ASSIGNED_BY_ID', 'TITLE'],
              method: 'crm.lead.list',
              id_wrapper: 'ID',
            },
            delete: {
              method: 'crm.lead.delete',
              param: 'id',
            }
          });
        },
        serialize: function (query) {
          return SERIALIZE.serializeLead(query);
        },
        table: function (array) {
          return TABLE.serializeLead(array);
        },
        fields: function () {
          FIELDS.createIdPicker();
          FIELDS.createDatePicker();
          FIELDS.createUserPicker();
          FIELDS.createNamePicker();
          FIELDS.createStatusPicker();
        }
      },
      {
        name: 'company',
        label: 'Компания',
        labels: ['компания', 'компании', 'компаний'],
        path: '/crm/company/details/',
        entity: {},
        new: function () {
          return this.entity = new Entities({
            list: {
              select: ['ID', 'DATE_CREATE', 'ASSIGNED_BY_ID', 'TITLE'],
              method: 'crm.company.list',
              id_wrapper: 'ID',
            },
            delete: {
              method: 'crm.company.delete',
              param: 'id',
            }
          });
        },
        serialize: function (query) {
          return SERIALIZE.serializeCompany(query);
        },
        table: function (array) {
          return TABLE.serializeLead(array);
        },
        fields: function () {
          FIELDS.createIdPicker();
          FIELDS.createDatePicker();
          FIELDS.createUserPicker();
          FIELDS.createNamePicker();
        }
      },
      {
        name: 'task',
        label: 'Задача',
        labels: ['задача', 'задачи', 'задач'],
        path: '/company/personal/user/0/tasks/task/view/', //?я не знаю как открыть по другому в слайдере
        entity: {},
        new: function () {
          return this.entity = new Entities({
            list: {
              select: ['ID', 'CREATED_DATE', 'RESPONSIBLE_ID', 'TITLE'],
              method: 'tasks.task.list',
              wrapper: 'tasks',
              id_wrapper: 'id',
            },
            delete: {
              method: 'tasks.task.delete',
              param: 'taskId',
            }
          });
        },
        serialize: function (query) {
          return SERIALIZE.serializeTask(query);
        },
        table: function (array) {
          return TABLE.serializeTask(array);
        },
        fields: function () {
          FIELDS.createIdPicker();
          FIELDS.createDatePicker();
          FIELDS.createUserPicker();
          FIELDS.createNamePicker();
          FIELDS.createTaskStatusPicker();
        }
      },
    ];

    //самописный обработчик формы, выплевывает ассоциативный объект
    //!!! выпленет массив только если обрабатываемый инпут имеет в названии [], например name="users[]" !!!
    jQuery.fn.serializeObject = function () {
      var arrayData, objectData;
      arrayData = this.serializeArray();
      objectData = {};
      $.each(arrayData, function () {
        var value;
        if (this.value != null) {
          value = this.value;
        } else {
          value = '';
        }
        if (this.name.includes('[]')) {
          objectData[this.name] != null ? objectData[this.name].push(value) : objectData[this.name] = [value];
        } else {
          objectData[this.name] = value;
        }
      });
      return objectData;
    };
  </script>
  <script>//В этом блоке вся работа с DOM деревом
    /**
     * Блок с инициализацией приложения и работой после прогрузки страницы
     **/
    $(document).ready(async function () {

      const app = {

        entity: {},
        query: {},
        count: 0,
        cancel: false,
        users: [],

        height: 0,

        html: '#app',

        selectType: '#select-entity',
        filter: '#filter',
        form: '#filter-form',
        filterMenu: '#filter-menu',
        showTable: '#show-table',
        deleteAll: '#delete-all',
        filterTable: '#filter-table',
        tableOffcanvas: '#filter-offcanvas',
        confirmModal: '#confirm',
        cancelButton: '#cancel-req',
        filterCardsWrapper: '#filter-cards-wrapper',

        filterCardsClass: 'filter-card',

        init: async function () {

          const self = this;

          this.bs.init();
          this.ac = new AbortController();
          FIELDS.callback = function (data) { //тут надо тоже вынести классы
            if (!data) return;
            $(self.filterCardsWrapper).find(`.${self.filterCardsClass}[data-target="${data.parent}"][data-name="${data.name}"]`).remove();
            $(self.filterCardsWrapper).append(`<div class="col-auto ${self.filterCardsClass} d-inline-flex p-0 my-1" data-target="${data.parent}" data-name="${data.name}"></div>`);
            const parent = $(self.filterCardsWrapper).find(`.${self.filterCardsClass}[data-target="${data.parent}"][data-name="${data.name}"]`);
            if (data.value) {
              parent.append(`<div id="${data.name}-wrapper" class="input-wrapper px-1 mx-1 my-auto badge text-bg-primary">
              <span class="label-wrapper">${data.label || 'Не задан'}</span>
              <span class="value-wrapper">${data.value}</span>
              <span class="remove_from_filter mx-1">×</span>
            </div>`);
            }
            $('.' + self.filterCardsClass).click(function (e) {
              e.stopPropagation();
              self.bs.dropDownMenu.toggle();
            });
            $('.remove_from_filter').click(function (e) {
              e.stopPropagation();
              self.bs.dropDownMenu.toggle();
              let parent = $(this).parent().parent(),
                target = parent.attr('data-target'),
                name = parent.attr('data-name');
              $(target).find('input[name="' + name + '"]').val('').change();
              $(target).find('select[name="' + name + '[]"]').val('').change();
            });
            self.updateData();
          }
          FIELDS.form = this.form;


          {
            let res = await BX24Client.call('user.get', {});
            let users_list = res.data();
            while (res.more()) {
              res = await BX24Client.next(res);
              users_list = users_list.concat(res.data());
            }
            this.users = users_list.map(e => ({
              name: e.NAME && e.LAST_NAME ? e.NAME + ' ' + e.LAST_NAME : 'Нет имени (id: ' + e.ID + ')',
              id: e.ID,
              photo: e.PERSONAL_PHOTO || './img/unknow-user.svg',
            }));
          }
          FIELDS.users = this.users;

          {
            let h = $(this.html).height();
            this.height = h + 500;
            $(this.html).height(this.height);
            this.fitWindow();
          }

          $(this.tableOffcanvas).on('shown.bs.offcanvas', function (e) {
            const h = $(self.filterTable).height();
            if (self.height < h + 400) {
              BX24.resizeWindow(h + 400, h + 400, (result) => { BX24.fitWindow(); });
            }
          });

          $(this.tableOffcanvas).on('hidden.bs.offcanvas', function (e) {
            $(self.html).height(self.height);
            self.fitWindow();
          });

          $(this.cancelButton).click(function () {
            $(this).prop('disabled', true);
            self.loader.update({
              title: 'Отмена',
              progress_title: 'Прерывание операций...'
            });
            self.cancel = true;
          });

          $('.' + this.table.sortButtonClass).click(function () {
            const reverse = $(this).hasClass('reverse'),
              target = $(this).attr('data-target'),
              type = $(this).attr('data-type');

            $('.' + self.table.sortButtonClass).removeClass('forward reverse active');
            $(this).addClass('active');
            if (!reverse) $(this).addClass('reverse');
            else $(this).addClass('forward');

            self.table.sortTable(self, reverse, target, type);
          });

          $(this.deleteAll).click(async function () {
            if (!self.query || !self.count) return;
            const flag = await self.dialog(`Вы действительно хотите удалить ${self.count} ${self.declOfNum(self.count, self.entity.labels)}?`);
            if (!flag) return;
            $(this).prop('disabled', true);
            self.cancel = false;
            const duration_timeout = 400;
            if (self.table.expired) {

              self.loader.update({
                title: 'Получение ' + self.declOfNum(5, self.entity.labels),
                progress: 0,
                progress_title: '0 / ' + self.count
              });
              self.loader.show(self);

              $(self.cancelButton).prop('disabled', false);

              let __filter = self.entity.serialize(self.query), __client = self.entity.new(), table_res = [];

              try {
                let duration = 0;
                table_res = await __client.getTest({
                  filter: __filter,
                  select: ['ID'],
                  callback: function (res, c) {
                    self.loader.update({
                      progress: Math.trunc((c / self.count) * 100),
                      progress_title: c + ' / ' + self.count,
                      approximate: {
                        time: res.time,
                        count: Math.ceil((self.count - c) / 2500)
                      },
                    });
                    return { cancel: self.cancel };
                  },
                  timeout: function (res, c) {
                    self.loader.update({
                      progress_title: 'Техническая пауза...',
                      approximate: {
                        time: res.time,
                        count: Math.ceil((self.count - c) / 2500),
                        timeout: 120,
                      },
                    });
                  }
                });
              } catch (e) {
                if (e !== 'Cancel') return console.error(e);
                await timeout(1000);
                self.loader.hide(self);
                $(this).prop('disabled', false);
                $(self.cancelButton).prop('disabled', false);
                await self.updateData();
                return;
              }

              let serialize_table = self.entity.table(table_res);

              self.loader.update({
                title: 'Удаление ' + self.declOfNum(5, self.entity.labels),
                progress: 0,
                progress_title: '0 / ' + self.count
              });
              try {
                let duration = 0;
                await __client.deleteAll({
                  entityList: serialize_table,
                  callback: function (res, c) {
                    self.loader.update({
                      progress: Math.trunc((c / self.count) * 100),
                      progress_title: c + ' / ' + self.count,
                      approximate: {
                        time: res.time,
                        count: Math.ceil((self.count - c) / 50)
                      },
                    });
                    return { cancel: self.cancel };
                  },
                  timeout: function (res, c) {
                    self.loader.update({
                      progress_title: 'Техническая пауза...',
                      approximate: {
                        time: res.time,
                        count: Math.ceil((self.count - c) / 2500),
                        timeout: 120,
                      },
                    });
                  }
                });
              } catch (e) {
                if (e !== 'Cancel') return console.error(e);
                await timeout(1000);
                self.loader.hide(self);
                $(this).prop('disabled', false);
                $(self.cancelButton).prop('disabled', false);
                await self.updateData();
                return;
              }
            } else {

              self.loader.update({
                title: 'Удаление ' + self.declOfNum(5, self.entity.labels),
                progress: 0,
                progress_title: '0 / ' + self.count
              });
              self.loader.show(self);
              $(self.cancelButton).prop('disabled', false);

              let __client = self.entity.new();
              try {
                let duration = 0;
                await __client.deleteAll({
                  entityList: self.table.data,
                  callback: function (res, c) {
                    self.loader.update({
                      progress: Math.trunc((c / self.count) * 100),
                      progress_title: c + ' / ' + self.count,
                      approximate: {
                        time: res.time,
                        count: Math.ceil((self.count - c) / 50)
                      },
                    });
                    return { cancel: self.cancel };
                  },
                  timeout: function (res, c) {
                    self.loader.update({
                      progress_title: 'Техническая пауза...',
                      approximate: {
                        time: res.time,
                        count: Math.ceil((self.count - c) / 2500),
                        timeout: 120,
                      },
                    });
                  }
                });
              }
              catch (e) {
                if (e !== 'Cancel') return console.error(e);
                await timeout(1000);
                self.loader.hide(self);
                $(this).prop('disabled', false);
                $(self.cancelButton).prop('disabled', false);
                await self.updateData();
                return;
              }
            }

            await timeout(1000);
            self.loader.hide(self);
            await self.updateData();
            //костыль на слип для бутстраповского модального окна
            function timeout(ms) {
              return new Promise(resolve => setTimeout(resolve, ms));
            }
          });

          $(this.selectType).change(function () {
            const type = $(this).val();

            $(self.form).empty();
            $('.' + self.filterCardsClass).empty();

            self.entity = ENTITIES.find(e => e.name === type);
            if (!self.entity) throw 'Unknow type of entity!';
            self.entity.fields();

            self.updateData();
          });

          $(this.showTable).click(async function () {
            if (!self.table.expired) return self.table.show(self);

            $(this).prop('disabled', true);
            self.cancel = false;
            const duration_timeout = 400;

            let serialize_users = self.users;

            self.loader.update({
              title: 'Получение ' + self.declOfNum(5, self.entity.labels),
              progress: 0,
              progress_title: '0 / ' + self.count,
            });
            $(self.cancelButton).prop('disabled', false);
            self.loader.show(self);

            let __filter = self.entity.serialize(self.query), __client = self.entity.new(), table_res = [];
            try {
              let duration = 0;
              table_res = await __client.getTest({
                filter: __filter,
                callback: function (res, c) {
                  self.loader.update({
                    progress: Math.trunc((c / self.count) * 100),
                    progress_title: c + ' / ' + self.count,
                    approximate: {
                      time: res.time,
                      count: Math.ceil((self.count - c) / 2500)
                    },
                  });
                  return { cancel: self.cancel };
                },
                timeout: function (res, c) {
                  self.loader.update({
                    progress_title: 'Техническая пауза...',
                    approximate: {
                      time: res.time,
                      count: Math.ceil((self.count - c) / 2500),
                      timeout: 120,
                    },
                  });
                }
              });
            } catch (e) {
              if (e !== 'Cancel') return console.error(e);
              await timeout(1000);
              self.loader.hide(self);
              $(this).prop('disabled', false);
              $(self.cancelButton).prop('disabled', false);
              await self.updateData();
              return;
            }
            let serialize_table = self.entity.table(table_res);
            let result_table = serialize_table.map(e => ({
              id: e.id,
              title: e.title,
              created: e.created,
              user: serialize_users.find(u => u.id === e.user) || { name: 'Не найден', id: -1, photo: './img/unknow-user.svg' },
              path: self.entity.path,
            }));
            self.table.init(result_table, self);

            await timeout(1000);

            $(this).prop('disabled', false);
            self.loader.hide(self);
            return self.table.show(self);

            //костыль на слип для бутстраповского модального окна
            function timeout(ms) {
              return new Promise(resolve => setTimeout(resolve, ms));
            }
          });
          $(this.selectType).trigger('change');
        },
        fitWindow: function () {
          BX24.resizeWindow($(this.html).width(), $(this.html).height(), (result) => { BX24.fitWindow(); });
        },
        declOfNum: function (number, titles) {
          cases = [2, 0, 1, 1, 1, 2];
          return titles[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
        },
        updateData: async function () { //тут надо тоже вынести классы
          $('.filter-button').prop('disabled', true);

          this.query = $(this.form).serializeObject();
          this.table.expired = true;

          let __filter = this.entity.serialize(this.query), __client = this.entity.new();
          this.count = await __client.count({ filter: __filter });

          $('.entity-type').text(this.entity.label);
          $('.entity-count').text(`${this.count} ${this.declOfNum(this.count, this.entity.labels)}`);
          $('.filter-button').prop('disabled', this.count < 1);
        },
        dialog: async function (text) { //тут надо тоже вынести классы
          if (!this.bs.confirmModal) this.bs.init();
          return new Promise((complete, failed) => {
            const modal = $(this.confirmModal);
            modal.find('.modal-body').text(text);
            modal.find('.modal-footer > .confirm-yes').click(() => {
              this.bs.confirmModal.hide();
              $(this.loader.html).css('z-index', '');
              complete(true);
            });
            modal.find('.modal-footer > .confirm-no').click(() => {
              this.bs.confirmModal.hide();
              $(this.loader.html).css('z-index', '');
              complete(false);
            });
            modal.on('hidePrevented.bs.modal', () => {
              this.bs.confirmModal.hide();
              $(this.loader.html).css('z-index', '');
              complete(false);
            });
            $(this.loader.html).css('z-index', '1049');
            this.bs.confirmModal.show();
          });
        },
        loader: {
          html: '#loader',

          titleClass: 'modal-title',
          progressbarClass: 'progressbar-bar',
          progressbarTitleClass: 'progressbar-status-percent',
          approximateClass: 'progressbar-text-after',

          update: function (settings) {
            if (settings.title) $(this.html).find('.' + this.titleClass).text(settings.title);
            if (settings.progress != null) $(this.html).find('.' + this.progressbarClass).css('width', settings.progress + '%')
            if (settings.progress_title) $(this.html).find('.' + this.progressbarTitleClass).text(settings.progress_title);
            if (settings.approximate) this.updateApproximate(settings.approximate);
          },
          updateApproximate: function (settings) {
            const approximate = Math.max(settings.time, 0.5) * settings.count + (settings.timeout || 0);
            let minutes = Math.floor(approximate / 60);
            let seconds = (approximate % 60).toFixed(0);
            $(this.html).find('.' + this.approximateClass).text(`Осталось: ~ ${Math.trunc(minutes)} мин. ${Math.trunc(seconds)} сек.`);
          },
          show: function (parent) {
            parent.bs.loaderModal.show();
          },
          hide: function (parent) {
            parent.bs.loaderModal.hide();
          },
        },
        bs: {
          tableOffcanvas: {},
          confirmModal: {},
          loaderModal: {},
          dropDownMenu: {},
          init: function () {
            this.dropDownMenu = new bootstrap.Dropdown(document.getElementById('filter'));
            this.tableOffcanvas = new bootstrap.Offcanvas(document.getElementById('filter-offcanvas'));
            this.confirmModal = new bootstrap.Modal(document.getElementById('confirm'));
            this.loaderModal = new bootstrap.Modal(document.getElementById('loader'));
          }
        },
        table: {
          html: '#filter-table',
          data: [],
          pages_data: [],
          page: 0,
          page_size: 50,
          expired: true,
          step_size: 4,

          buttonsWrapperClass: 'actions-wrapper',
          deleteButtonClass: 'delete-obj',
          openPathClass: 'open-path',
          paginationWrapperClass: 'pagination-wrapper',
          gotoPageClass: 'goto-page',
          gotoNextPageClass: 'goto-next',
          gotoPrevPageClass: 'goto-prev',
          gotoFirstPageClass: 'goto-first',
          gotoLastPageClass: 'goto-last',
          userAvatarClass: 'user-avatar',
          sortButtonClass: 'th-sort-table',

          init: function (__table, parent) {
            const self = this;
            this.data = __table;
            this.page = 0;
            let local_table = JSON.parse(JSON.stringify(__table)), result = [], length = this.page_size;
            while (local_table.length) result.push(local_table.splice(0, length));
            this.pages_data = result;
            $('.' + this.paginationWrapperClass).empty();
            if (result.length > 1) this.createPagination(parent);
            this.createTable(parent);
            this.expired = false;
          },
          show: function (parent) {
            parent.bs.tableOffcanvas.show();
          },
          hide: function (parent) {
            parent.bs.tableOffcanvas.show();
          },
          createTable: function (parent) {
            const self = this;
            $(this.html).find('tbody').empty();
            for (let t of this.pages_data[this.page]) {
              $(this.html).find('tbody').append(`
                <tr>
                  <th scope="row" style="max-width: 6rem">${t.id}</th>
                  <td style="max-width: 16rem" class="${this.openPathClass} link-primary text-truncate" data-path="${t.path + t.id}/">${t.title}</td>
                  <td style="max-width: 8rem" class="${t.user.id !== -1 ? this.openPathClass + ' link-primary ' : ''} text-truncate" ${t.user.id !== -1 ? `data-path="/company/personal/user/${t.user.id}/"` : ''}>
                    <img class="${this.userAvatarClass} rounded-circle" src="${t.user.photo}" alt="user avatar">
                    ${t.user.name}
                  </td>
                  <td style="max-width: 8rem" class="text-truncate">${new Date(t.created).toLocaleDateString('ru-RU')}</td>
                  <th style="max-width: 10%" class="text-center ${this.buttonsWrapperClass}">
                    <button type="button" class="btn btn-danger btn-sm ${this.deleteButtonClass}" data-id="${t.id}">Удалить</button>
                  </th>
                </tr>`);
            }
            $('.' + this.deleteButtonClass).click(async function () {
              $(this).prop('disabled', true);
              const id = parseInt($(this).attr('data-id')), flag = await parent.dialog(`Вы действительно хотите удалить ${parent.declOfNum(1, parent.entity.labels)} с id: ${id} ?`);
              if (!flag) return $(this).prop('disabled', false);
              $(this).html(`<div class="spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">Удаление...</span>
                </div>`);
              let client = parent.entity.new();
              try {
                await client.delete({ id: id });
              } catch (e) {
                console.error(e);
                $(this).html('Ошибка!');
                return $(this).prop('disabled', false);
              }
              $(this).html('Удален');
              $(this).removeClass('btn-danger');
              $(this).addClass('btn-secondary');
              $(this).parent().parent().addClass('opacity-50');
            });
            $('.' + this.openPathClass).click(function (e) {
              const path = $(this).data('path');
              if (!path) return;
              BX24.openPath(
                path,
                function (result) {
                  if (result.result === 'error')
                    window.open(document.referrer + path.substring(1), '_blank').focus();
                }
              );
            });
          },
          createPagination: function (parent) {
            const self = this, step_size = this.step_size;
            $('.' + this.paginationWrapperClass).empty();

            let local_page = this.page, start_offset = 0, end_offset = 0;
            if (this.pages_data.length - (local_page + step_size + 1) < 0) start_offset = -(this.pages_data.length - (local_page + step_size + 1));
            if (local_page - step_size < 0) end_offset = -(local_page - step_size);

            $('.' + this.paginationWrapperClass).append(`
              <ul class="pagination">
                <li class="page-item"><button class="page-link ${this.gotoFirstPageClass}" aria-label="Первая"><span aria-hidden="true">&laquo;&laquo;</span></button></li>
                <li class="page-item"><button class="page-link ${this.gotoPrevPageClass}" aria-label="Предыдущая"><span aria-hidden="true">&laquo;</span></button></li>
              </ul>`);
            for (let i = Math.max(0, this.page - step_size - start_offset); i <= Math.min(this.pages_data.length - 1, local_page + step_size + end_offset); i++) {
              $('.' + this.paginationWrapperClass).find('.pagination').append(`
              <li class="page-item"><button class="page-link ${this.gotoPageClass} ${i == this.page ? 'active' : ''}" page="${i}">${i + 1}</button></li>`);
            }
            $('.' + this.paginationWrapperClass).find('.pagination').append(`
              <li class="page-item"><button class="page-link ${this.gotoNextPageClass}" aria-label="Следующая"><span aria-hidden="true">&raquo;</span></button></li>
              <li class="page-item"><button class="page-link ${this.gotoLastPageClass}" aria-label="Последняя"><span aria-hidden="true">&raquo;&raquo;</span></button></li>`);
            $('.' + this.gotoNextPageClass).prop('disabled', this.page === this.pages_data.length - 1);
            $('.' + this.gotoPrevPageClass).prop('disabled', this.page === 0);
            $('.' + this.gotoLastPageClass).prop('disabled', this.page === this.pages_data.length - 1);
            $('.' + this.gotoFirstPageClass).prop('disabled', this.page === 0);
            $('.' + this.gotoPageClass).click(function () {
              const local_page = parseInt($(this).attr('page'));
              if (local_page >= 0 && local_page <= self.pages_data.length - 1) {
                self.page = local_page;
                return self.changePage(parent);
              }
            });
            $('.' + this.gotoNextPageClass).click(function () {
              if (self.page >= self.pages_data.length - 1) self.page = self.pages_data.length - 1
              else self.page++;
              return self.changePage();
            });
            $('.' + this.gotoPrevPageClass).click(function () {
              if (self.page < 1) self.page = 0;
              else self.page--;
              return self.changePage(parent);
            });
            $('.' + this.gotoLastPageClass).click(function () {
              self.page = self.pages_data.length - 1;
              return self.changePage(parent);
            });
            $('.' + this.gotoFirstPageClass).click(function () {
              self.page = 0;
              return self.changePage(parent);
            });
          },
          changePage: function (parent) {
            this.createTable(parent);
            this.createPagination(parent);
          },
          sortTable: function (parent, reverse, target, type) {
            if (this.data.length < 1) return;
            if (!this.data[0].hasOwnProperty(target)) return;
            const __sort = function (__reverse, __target, __type) {
              return function (a, b) {
                if (target === 'user')
                  if (type === 'string') return reverse ?
                    b.user.name.toString().localeCompare(a.user.name.toString()) :
                    a.user.name.toString().localeCompare(b.user.name.toString());
                  else return reverse ? b.user.id - a.user.id : a.user.id - b.user.id;
                if (type === 'integer') return reverse ? b[target] - a[target] : a[target] - b[target];
                if (type === 'string') return reverse ?
                  b[target].toString().localeCompare(a[target].toString()) :
                  a[target].toString().localeCompare(b[target].toString());
                if (type === 'date') return reverse ? new Date(b[target]) - new Date(a[target]) : new Date(a[target]) - new Date(b[target]);
                throw 'Unknow type of sort!';
              }
            }
            this.page = 0;
            this.data.sort(__sort(reverse, target, type));
            let local_table = JSON.parse(JSON.stringify(this.data)), result = [], length = this.page_size;
            while (local_table.length) result.push(local_table.splice(0, length));
            this.pages_data = result;
            if (result.length > 1) this.createPagination(parent);
            this.createTable(parent);
          }
        }
      }

      await app.init();
    });
  </script>
</body>

</html>